id: test-rel01.0-uc002-generation-lifecycle
title: Generation lifecycle from start to stop
traces:
  - rel01.0-uc002-generation-lifecycle
  - prd002-generation-lifecycle
tags:
  - integration

preconditions:
  - Clean git repository on main branch
  - Beads initialized
  - At least one Go source directory configured
  - configuration.yaml present with cycles=1 and max_issues=1

test_cases:
  - name: GeneratorStart creates tagged generation branch
    inputs:
      command: mage generator:start
    expected:
      exit_code: 0
      state:
        current_branch_prefix: "generation-"
        tag_exists_suffix: "-start"
        go_files_deleted: true
        go_mod_exists: true

  - name: GeneratorStart fails when not on main
    inputs:
      command: |
        git checkout -b feature
        mage generator:start
    expected:
      exit_code: 1
      stderr_contains: "switching to main"

  - name: GeneratorRun executes configured cycles
    description: After generator:start, run executes the number of cycles from configuration.yaml
    inputs:
      command: mage generator:run
      env:
        config: "cycles: 1, max_issues: 1"
    expected:
      exit_code: 0
      stdout_contains: "complete, ran 1 cycle(s)"

  - name: GeneratorStop merges to main and tags
    inputs:
      command: mage generator:stop
    expected:
      exit_code: 0
      state:
        current_branch: "main"
        tag_exists_suffix: "-finished"
        tag_exists_suffix_2: "-merged"
        generation_branch_deleted: true

  - name: GeneratorList shows all generations
    inputs:
      command: mage generator:list
    expected:
      exit_code: 0
      stdout_contains: "generation-"

  - name: GeneratorReset returns to clean main
    inputs:
      command: mage generator:reset
    expected:
      exit_code: 0
      state:
        current_branch: "main"
        generation_branches: 0

  - name: GeneratorSwitch saves work and changes branch
    description: Set generation_branch in configuration.yaml to "main" before switching
    inputs:
      command: |
        mage generator:start
        mage generator:switch
      env:
        config: "generation_branch: main"
    expected:
      exit_code: 0
      state:
        current_branch: "main"

cleanup:
  - Switch to main
  - Delete all generation branches
  - Remove generation tags
